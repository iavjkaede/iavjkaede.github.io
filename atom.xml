<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>归云阁</title>
  
  <subtitle>御风千万里，终须雀归阁</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://blog.iavjkaede.com/"/>
  <updated>2020-06-21T13:19:43.246Z</updated>
  <id>http://blog.iavjkaede.com/</id>
  
  <author>
    <name>潇枫11</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>基于netcore 编写本地服务</title>
    <link href="http://blog.iavjkaede.com/2020/06/21/Create%20native%20service%20with%20dotnet/"/>
    <id>http://blog.iavjkaede.com/2020/06/21/Create%20native%20service%20with%20dotnet/</id>
    <published>2020-06-21T13:19:43.246Z</published>
    <updated>2020-06-21T13:19:43.246Z</updated>
    
    <content type="html"><![CDATA[<h1 id="基于-netcore-编写本地服务"><a href="#基于-netcore-编写本地服务" class="headerlink" title="基于.netcore 编写本地服务"></a>基于.netcore 编写本地服务</h1><p>服务程序，一般代表一些需要长期稳定运行，没有界面交互的程序，周而复始，生生不息。那么,怎么用.netcore 来编织这么一个程序呢？</p><h2 id="利器"><a href="#利器" class="headerlink" title="利器"></a>利器</h2><p>以下是在下所使用的工具</p><ul><li>VisualStduio 2019</li><li>.netcore 3.1</li></ul><h2 id="起始"><a href="#起始" class="headerlink" title="起始"></a>起始</h2><h3 id="道生一-使用Woker-Service-模板创建服务"><a href="#道生一-使用Woker-Service-模板创建服务" class="headerlink" title="道生一 | 使用Woker Service 模板创建服务"></a>道生一 | 使用Woker Service 模板创建服务</h3><p>启动<code>VisualStudio 2019</code>，选择<code>创建新项目</code>,在上方的搜索栏搜索<code>service</code> ,如下图。</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://image.zsver.com/2020/06/01/45ed7d8f41ad2.png" alt="创建Worker Service"></p><p>或者使用<code>dotnet new worker</code></p><p>这里在下创建一个名为<code>MyService</code>的项目</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet new worker -n MyService</span><br></pre></td></tr></table></figure><p>窥探一番项目文件，可见里面有两个主要的文件</p><ul><li><h4 id="Program-cs"><a href="#Program-cs" class="headerlink" title="Program.cs"></a>Program.cs</h4></li></ul><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  CreateHostBuilder(args).Build().Run();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IHostBuilder <span class="title">CreateHostBuilder</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span> =&gt;</span><br><span class="line">          Host.CreateDefaultBuilder(args)</span><br><span class="line">              .ConfigureServices((hostContext, services) =&gt;</span><br><span class="line">              &#123;</span><br><span class="line">                  services.AddHostedService&lt;Worker&gt;();</span><br><span class="line">              &#125;);</span><br></pre></td></tr></table></figure><ul><li><h4 id="Worker-cs"><a href="#Worker-cs" class="headerlink" title="Worker.cs"></a>Worker.cs</h4></li></ul><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Worker</span> : <span class="title">BackgroundService</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;Worker&gt; _logger;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">Worker</span>(<span class="params">ILogger&lt;Worker&gt; logger</span>)</span></span><br><span class="line"><span class="function"></span>       &#123;</span><br><span class="line">           _logger = logger;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">async</span> Task <span class="title">ExecuteAsync</span>(<span class="params">CancellationToken stoppingToken</span>)</span></span><br><span class="line"><span class="function"></span>       &#123;</span><br><span class="line">           <span class="keyword">while</span> (!stoppingToken.IsCancellationRequested)</span><br><span class="line">           &#123;</span><br><span class="line">               _logger.LogInformation(<span class="string">"Worker running at: &#123;time&#125;"</span>, DateTimeOffset.Now);</span><br><span class="line">               <span class="keyword">await</span> Task.Delay(<span class="number">1000</span>, stoppingToken);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>这两个文件都是相当简洁明了的。<br><code>Program.cs</code> 创建<code>Host</code>并对Worker进行托管。<br>那么Worker是什么?<br> &emsp; 从<code>Worker.cs</code>中可见Worker只是继承自<code>BackgroundService</code>的子类。<br><code>BackgroundService</code>又是何方神圣呢？<br>  &emsp;窥一眼<code>MyService</code>的项目依赖，依赖包里有<code>Microsoft.Extensions.Hosting</code>这一项，<code>BackgroundService</code>正是来自于此。<br>这么一看，不过如此，如果阁下不使用VS 模板来创建自己的服务，想必也是易如反掌。</p><h3 id="一生二-编写属于自己的Worker"><a href="#一生二-编写属于自己的Worker" class="headerlink" title="一生二 | 编写属于自己的Worker"></a>一生二 | 编写属于自己的Worker</h3><p>新建 <code>MyWorker.cs</code> 文件，内容如下</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">MyWorker</span> : <span class="title">BackgroundService</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">readonly</span> <span class="keyword">string</span>[] _lines =</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="string">"沉舟侧畔千帆过，"</span>,</span><br><span class="line">           <span class="string">"病树前头万木春。"</span>,</span><br><span class="line">           <span class="string">"-------------"</span>,</span><br><span class="line">           <span class="string">"长风破浪会有时，"</span>,</span><br><span class="line">           <span class="string">"直挂云帆济沧海。"</span>,</span><br><span class="line">           <span class="string">"-------------"</span>,</span><br><span class="line">           <span class="string">"谁无暴风劲雨时，"</span>,</span><br><span class="line">           <span class="string">"守得云开见月明。"</span>,</span><br><span class="line">           <span class="string">"-------------"</span></span><br><span class="line">       &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">protected</span> <span class="keyword">async</span> <span class="keyword">override</span> Task <span class="title">ExecuteAsync</span>(<span class="params">CancellationToken stoppingToken</span>)</span></span><br><span class="line"><span class="function"></span>       &#123;</span><br><span class="line">           <span class="keyword">while</span>(!stoppingToken.IsCancellationRequested)</span><br><span class="line">           &#123;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">foreach</span> (<span class="keyword">var</span> line <span class="keyword">in</span> _lines)</span><br><span class="line">               &#123;</span><br><span class="line">                   <span class="keyword">await</span> Task.Delay(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">                   <span class="keyword">foreach</span> (<span class="keyword">var</span> ch <span class="keyword">in</span> line)</span><br><span class="line">                   &#123;</span><br><span class="line">                       Console.Write(ch);</span><br><span class="line">                       <span class="keyword">await</span> Task.Delay(<span class="number">100</span>);</span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line">                   Console.Write(<span class="string">"\r"</span>);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>除此之外，还需要将Worker 注入。<br><code>services.AddHostedService&lt;MyWorker&gt;();</code><br>注释掉 <code>services.AddHostedService&lt;Worker&gt;();</code>,而只关注<code>MyWorker</code></p><p>运行之后，就可以看到内容输出了。这点很重要，为什么还会有控制台窗口，而不是一个无界面的服务？<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://image.zsver.com/2020/06/01/1a5bde9b72a3e.gif" alt="运行情况"><br>嗯，现在它还是一个控制台程序。<br>那么，如和部署成服务呢？  </p><h3 id="三生万物-部署Windows-服务"><a href="#三生万物-部署Windows-服务" class="headerlink" title="三生万物 | 部署Windows 服务"></a>三生万物 | 部署Windows 服务</h3><p>首先，要做一些改动  </p><ol><li><p>为<code>MyService</code>项目添加nuget包 <code>Microsoft.Extensions.Hosting.WindowsServices</code></p></li><li><p>修改 <code>Program.cs</code> 中的 <code>CreateHostBuilder</code> 函数，在最后加上 <code>UseWindowsService()</code><br>如下  </p></li></ol><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> IHostBuilder <span class="title">CreateHostBuilder</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>          =&gt; Host.CreateDefaultBuilder(args).ConfigureServices(services =&gt;</span><br><span class="line">          &#123;</span><br><span class="line">              services.AddHostedService&lt;MyWorker&gt;();</span><br><span class="line">          &#125;).UseWindowsService();</span><br></pre></td></tr></table></figure><p>接着<br>这里需要使用另一把武器 <code>sc</code><br>打开cmd窗口（使用Powershell 也可以，但是低版本的Powershell 可能会出错）</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sc create MyService binpath=E:\full\path\to\yourbinaryfile.exe</span><br><span class="line"><span class="comment"># binpath 一定是绝对路径，否则运行服务会提示系统找不到指定文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 另外</span></span><br><span class="line">sc start MyService</span><br><span class="line">sc stop MyService</span><br><span class="line">sc delete MyService</span><br></pre></td></tr></table></figure><p>程序在控制台输出，所以安装成服务并不能看到效果。谁管呢，总而言之，使用.netcore创建服务程序很简单，这种方式用在.netframework上又当如何呢？阁下可自行尝试，此处不再多言。  </p><p>&emsp;<em>更多创建服务的方式，可以点击下面的引用链接</em></p><h2 id="终"><a href="#终" class="headerlink" title="终"></a>终</h2><h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p><a href="https://dotnetcoretutorials.com/2019/12/07/creating-windows-services-in-net-core-part-3-the-net-core-worker-way/" target="_blank" rel="noopener">Creating Windows Services In .NET Core – Part 3 – The “.NET Core Worker” Way</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;基于-netcore-编写本地服务&quot;&gt;&lt;a href=&quot;#基于-netcore-编写本地服务&quot; class=&quot;headerlink&quot; title=&quot;基于.netcore 编写本地服务&quot;&gt;&lt;/a&gt;基于.netcore 编写本地服务&lt;/h1&gt;&lt;p&gt;服务程序，一般代表一
      
    
    </summary>
    
    
      <category term=".NET" scheme="http://blog.iavjkaede.com/categories/NET/"/>
    
    
      <category term="C#" scheme="http://blog.iavjkaede.com/tags/C/"/>
    
      <category term="Service" scheme="http://blog.iavjkaede.com/tags/Service/"/>
    
  </entry>
  
  <entry>
    <title>Linux子系统（WSL）Debian安装aria2并配置AriaNg</title>
    <link href="http://blog.iavjkaede.com/2020/05/18/Install%20Aria2%20for%20Debian%20WSL/"/>
    <id>http://blog.iavjkaede.com/2020/05/18/Install%20Aria2%20for%20Debian%20WSL/</id>
    <published>2020-05-18T15:22:37.125Z</published>
    <updated>2020-05-23T08:51:57.344Z</updated>
    
    <content type="html"><![CDATA[<h2 id="环境简介"><a href="#环境简介" class="headerlink" title="环境简介"></a>环境简介</h2><h3 id="系统环境"><a href="#系统环境" class="headerlink" title="系统环境"></a>系统环境</h3><p>Window 10 LTSC 2019  <strong>开启WSL</strong></p><p>WSL 使用 <strong>Debian 发行版</strong></p><h3 id="Shell-环境"><a href="#Shell-环境" class="headerlink" title="Shell 环境"></a>Shell 环境</h3><p>ZSH</p><h3 id="将安装的软件版本"><a href="#将安装的软件版本" class="headerlink" title="将安装的软件版本"></a>将安装的软件版本</h3><p>aria2    版本 <strong>1.30.0</strong></p><p>AriaNg 版本 <strong>1.1.1</strong></p><h2 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h2><h3 id="安装aria2"><a href="#安装aria2" class="headerlink" title="安装aria2"></a>安装aria2</h3><p>首先进行<a href="https://github.com/aria2/aria2" target="_blank" rel="noopener">aria2</a> 的安装</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install aria2</span><br></pre></td></tr></table></figure><p>安装完成输入以下命令查看安装是否成功</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aria2c --version</span><br></pre></td></tr></table></figure><p>成功输出版本信息后，安装就完成了</p><h3 id="配置aria2"><a href="#配置aria2" class="headerlink" title="配置aria2"></a>配置aria2</h3><p><span id="aria2_conf">配置aria2</span></p><p>安装是很简单，配置aria2 却是有些棘手的，当然不进行配置也是可以使用的，这里不过多介绍，讲一下我自己的配置。</p><p>需要创建三个文件，分别用来保存aria2 的配置、会话和日志。</p><p>我这里在用户目录下建立文件夹，其实可以将配置目录放在Windows目录下，这样重新安装</p><p>WSL的时候就无需重新创建编写配置文件了。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> </span><br><span class="line">mkdir .aria2</span><br><span class="line"><span class="built_in">cd</span> .aria2</span><br><span class="line">touch aria2.conf</span><br><span class="line">touch aria2.session</span><br><span class="line">touch aria2.log</span><br></pre></td></tr></table></figure><p>完成后进行aria2 的配置，这里只记录我自己的配置，详细配置自行搜索查阅。</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Log Options</span></span><br><span class="line"></span><br><span class="line"><span class="attr">log-level</span>=warn</span><br><span class="line"><span class="attr">log</span>=/home/<span class="variable">$LOGNAME</span>/.aria2/aria2.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># Running on background</span></span><br><span class="line"><span class="attr">daemon</span>=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Download path</span></span><br><span class="line"><span class="comment"># 下载地址，可以放在Windows系统的目录下，比如以下是E盘的download</span></span><br><span class="line"><span class="attr">dir</span>=/mnt/e/Download</span><br><span class="line"></span><br><span class="line"><span class="comment"># Session Options</span></span><br><span class="line"><span class="attr">input-file</span>=/home/<span class="variable">$LOGNAME</span>/.aria2/aria2.session</span><br><span class="line"><span class="attr">save-session</span>=/home/<span class="variable">$LOGNAME</span>/.aria2/aria2.session</span><br><span class="line"><span class="attr">save-session-interval</span>=<span class="number">30</span></span><br><span class="line"></span><br><span class="line"><span class="attr">continue</span>=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Disk cache</span></span><br><span class="line"><span class="attr">disk-cache</span>=<span class="number">32</span>M</span><br><span class="line"></span><br><span class="line"><span class="comment"># RPC Options</span></span><br><span class="line"><span class="comment"># 因为只在本地使用，不用rpc安全设置也可以</span></span><br><span class="line"><span class="attr">enable-rpc</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">rpc-allow-origin-all</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">rpc-listen-port</span>=<span class="number">6800</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 其他更详细的配置自行查阅吧，或者待会我们配置AriaNg就可以具体看可以配置哪些内容了</span></span><br></pre></td></tr></table></figure><p><strong>$LOGNAME</strong> 替换成你用户名</p><p>使用配置文件启动 aria2</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aria2c --conf-path /home/<span class="variable">$LOGNAME</span>/.aria2/aria2.conf</span><br></pre></td></tr></table></figure><p><em>配置这个地方可能会有坑，如果配置文件写错了，这个命令可能没有任何报错就退出了，或者rpc没有成功开启。执行完这条命令后，在浏览器地址栏输入<a href="http://localhost:6800" target="_blank" rel="noopener">http://localhost:6800</a></em></p><p><em>如果出现404而不是未响应，说明rpc是正常开启了的（在没有其他进程占用6800端口的情况下），这里提及的端口号对应配置文件中的端口号<code>rpc-listen-port</code></em></p><p>另外，我不知道aria2 有没有检查配置文件的命令，我是用笨方法排除错误，把配置文件的<code>daemon=true</code> 去掉然后使用配置文件启动aria2c，会提示错误信息的。如果没有提示，可以先把不重要的配置注释掉再次启动，rpc是一定要开启的，其他配置对我来说比较次要。</p><h3 id="配置AriaNg"><a href="#配置AriaNg" class="headerlink" title="配置AriaNg"></a>配置AriaNg</h3><p>配置好aria2 可是如果每次下载文件都去执行命令，虽然很hacker，但并不是我想要的。我选择使用<a href="https://github.com/mayswind/AriaNg" target="_blank" rel="noopener">AriaNg</a>来操作aria2 ，AriaNg是一个基于Web的arai2 前端。可以在<strong>github</strong> 的<strong>Release</strong>页面中下载<strong>AllInOne</strong>版本。</p><p><a href="https://github.com/mayswind/AriaNg" target="_blank" rel="noopener">AriaNg Github</a></p><p>AllInOne 版本里面包含一个html文件，这就是我要的，我们直接双击打开在浏览器中查看。</p><p>当看到左侧菜单栏最后一条有已连接的绿色标志，表示链接成功。如果一致显示未连接，那可能是配置出了问题，应该仔细看看有没有正确<strong>配置aria2</strong>。</p><p>到这时候，我们已经能愉快的使用aria2了，但是，我还想完成两件事情。</p><ul><li><p>我希望把AriaNg部署成Web服务，而不是直接在本地去打开html文件（这很不酷）</p></li><li><p>我希望每次开机的时候自动启动aria2c</p></li></ul><h4 id="配置静态文件服务"><a href="#配置静态文件服务" class="headerlink" title="配置静态文件服务"></a>配置静态文件服务</h4><p>这里我将使用Nodejs来实现。</p><p>有关如何在WSL中安装Nodejs，请参考 <a href="/2020/05/18/Install%20nodejs%20for%20Debian%20WSL/" title="Linux子系统（WSL）Debian安装Nodejs">Linux子系统（WSL）Debian安装Nodejs</a></p><p>安装好Nodejs 后，确定一下npm 命令。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm --version</span><br></pre></td></tr></table></figure><p>我们<strong>建立一个目录存放静态页，将AriaNg（Index.html)文件放在该目录下，并cd 到该目录</strong></p><p>建立一个用于支持web服务的js文件。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">touch server.js</span><br></pre></td></tr></table></figure><p>编辑该文件输入以下内容并保存。</p><p><strong>server.js</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">let</span> app = express();</span><br><span class="line"></span><br><span class="line">app.use(express.static(<span class="string">"./"</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 端口号自行配置</span></span><br><span class="line">app.listen(<span class="number">8081</span>,()=&gt;&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'Server start !'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>emmmm，现在还不能运行，需要装一下<strong>express</strong> 依赖包✔</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install express --save</span><br></pre></td></tr></table></figure><p>启动服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node server.js</span><br></pre></td></tr></table></figure><p><em>这几个命令都是在最初建立的目录下完成的</em></p><p>当你看到终端输出<code>Server start !</code>，去浏览器输出<a href="http://localhost:8081，看是不是打开了AriaNg👌。">http://localhost:8081，看是不是打开了AriaNg👌。</a></p><p>现在打开了静态页服务，不过它还是在终端下执行的，关掉终端后，静态页服务也就关了。</p><h4 id="用Supervisor守护进程"><a href="#用Supervisor守护进程" class="headerlink" title="用Supervisor守护进程"></a>用Supervisor守护进程</h4><p>首先安装Supervisor</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install supervisor</span><br></pre></td></tr></table></figure><p>在我使用的debian中，安装后会在 <code>/etc/supervisor</code> 生成一个<strong>supervisord.conf</strong>文件和一个<strong>conf.d</strong>目录，我们可以在conf.d目录中建立配置。supervisord.conf文件中已经包含了它。<em>不能保证使用的环境都是一样的，这里只是我自己的环境。</em></p><h5 id="建立ariaNg-的supervisor配置文件"><a href="#建立ariaNg-的supervisor配置文件" class="headerlink" title="建立ariaNg 的supervisor配置文件"></a>建立ariaNg 的supervisor配置文件</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/supervisor/conf.d</span><br><span class="line">sudo vi ariaNg.conf</span><br></pre></td></tr></table></figure><p>配置文件内容如下</p><p><strong>ariaNg.conf</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[program:ariaNg]</span></span><br><span class="line"><span class="attr">command</span>=node server.js</span><br><span class="line"><span class="attr">directory</span>=/home/ariaNg<span class="comment">#配置静态页的目录</span></span><br><span class="line"><span class="attr">user</span>=root</span><br><span class="line"><span class="attr">autorestart</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">stderr_logfile</span>=/var/log/ariaNg/err.log</span><br><span class="line"><span class="attr">stdout_logfile</span>=/var/log/ariaNg/out.log</span><br></pre></td></tr></table></figure><h5 id="启动supervisor"><a href="#启动supervisor" class="headerlink" title="启动supervisor"></a>启动supervisor</h5><p>在启动supervisor前，可能需要建立ariaNg的日志目录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir /var/<span class="built_in">log</span>/ariaNg</span><br></pre></td></tr></table></figure><p>启动supervisor服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service supervisor start</span><br></pre></td></tr></table></figure><p>查看下运行状态</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo supervisorctl status</span><br></pre></td></tr></table></figure><p>看到<code>aria2Ng                          RUNNING</code> 然后去浏览器访问一下确定是否成功。</p><p>使用supervisorctl 的过程中可能会报<strong>unix:///var/run/supervisor.sock no such file</strong>这个错误。不要慌。</p><p>可以先看一下ariaNg 的log文件，看看是哪个地方出了问题。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /var/<span class="built_in">log</span>/ariaNg/err.log</span><br></pre></td></tr></table></figure><p>如果是配置的问题，就去修改配置文件。</p><p>然后停止supervisor 服务，再次启动。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo service supervisor stop</span><br><span class="line">sudo service supervisor start</span><br><span class="line"></span><br><span class="line">sudo supervisorctl status</span><br></pre></td></tr></table></figure><p>我当时直接重装了supervisor，因为刚开始没卸载干净，还重装了好几遍，😂。</p><p>当所有一切都配置好后，我们只需要在浏览器中就能使用aria2 了，不过，我还希望它们能在开机时自动启动。</p><h3 id="开机自动启动aria2"><a href="#开机自动启动aria2" class="headerlink" title="开机自动启动aria2"></a>开机自动启动aria2</h3><p>我可不想每次开机都要打开命令行然后输入命令去启动aria2</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aria2c --conf-path /home/<span class="variable">$LOGNAME</span>/.aria2/aria2.conf</span><br><span class="line">sudo service supervisor</span><br></pre></td></tr></table></figure><p>废话少说，有关如何设置在WSL中开机自动启动服务的方法先去这看一下吧。</p><a href="/2019/03/02/WSL%20Service%20Autostart/" title="Linux子系统(WSL)中的服务开机启动">Linux子系统(WSL)中的服务开机启动</a><p>配置好开机自启脚本后，只需要在init.wsl 中加入以下命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/supervisor <span class="variable">$1</span></span><br><span class="line">aria2c --conf-path=/home/xiaosen/.aria2/aria2.conf</span><br></pre></td></tr></table></figure><p>搞定👏👏👏</p><h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p>这大概就是我安装使用aria2 的整个过程了。</p><p><em>水平有限，如果某些地方不正确，恳请斧正，感谢！</em></p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://www.jianshu.com/p/6adf79d29add" target="_blank" rel="noopener">Aria2 配置详解</a></p><p><a href="https://blog.csdn.net/wenwushq/article/details/79827718" target="_blank" rel="noopener">用nodejs搭建静态网页服务器居然这么简单</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;环境简介&quot;&gt;&lt;a href=&quot;#环境简介&quot; class=&quot;headerlink&quot; title=&quot;环境简介&quot;&gt;&lt;/a&gt;环境简介&lt;/h2&gt;&lt;h3 id=&quot;系统环境&quot;&gt;&lt;a href=&quot;#系统环境&quot; class=&quot;headerlink&quot; title=&quot;系统环境&quot;&gt;&lt;/a
      
    
    </summary>
    
    
      <category term="Deploy" scheme="http://blog.iavjkaede.com/categories/Deploy/"/>
    
    
      <category term="WSL" scheme="http://blog.iavjkaede.com/tags/WSL/"/>
    
      <category term="Aria2" scheme="http://blog.iavjkaede.com/tags/Aria2/"/>
    
      <category term="Debian" scheme="http://blog.iavjkaede.com/tags/Debian/"/>
    
  </entry>
  
  <entry>
    <title>Linux子系统（WSL）Debian安装Nodejs</title>
    <link href="http://blog.iavjkaede.com/2020/05/18/Install%20nodejs%20for%20Debian%20WSL/"/>
    <id>http://blog.iavjkaede.com/2020/05/18/Install%20nodejs%20for%20Debian%20WSL/</id>
    <published>2020-05-18T15:22:37.125Z</published>
    <updated>2020-05-23T08:52:11.986Z</updated>
    
    <content type="html"><![CDATA[<h2 id="环境简介"><a href="#环境简介" class="headerlink" title="环境简介"></a>环境简介</h2><h3 id="系统环境"><a href="#系统环境" class="headerlink" title="系统环境"></a>系统环境</h3><p>Windows 10 LTSC 2019 </p><p><em>已安装 Nodejs</em></p><p><em>已开启 WSL</em></p><p>WSL ：Debian 发行版</p><h3 id="Shell-环境"><a href="#Shell-环境" class="headerlink" title="Shell 环境"></a>Shell 环境</h3><p>ZSH</p><h2 id="安装Nodejs"><a href="#安装Nodejs" class="headerlink" title="安装Nodejs"></a>安装Nodejs</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -sL https://deb.nodesource.com/setup_10.x | sudo -E bash -</span><br><span class="line">sudo apt install -y nodejs</span><br></pre></td></tr></table></figure><p><strong>相应的版本可在 setup_<em>10.x</em></strong> 处替换，例如 8.x/9.x</p><h2 id="检查是否安装成功"><a href="#检查是否安装成功" class="headerlink" title="检查是否安装成功"></a>检查是否安装成功</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node -v</span><br></pre></td></tr></table></figure><h2 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h2><p>因为是在WSL中安装，如果在Win10 中也安装了Nodejs，在WSL中使用npm命令会出现找不到npm的情况，下面说下怎么解决。</p><h3 id="先看一下npm在哪"><a href="#先看一下npm在哪" class="headerlink" title="先看一下npm在哪"></a>先看一下npm在哪</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">where</span> npm</span><br></pre></td></tr></table></figure><p>不出意料的情况下会显示以下内容</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/npm</span><br><span class="line">/mnt/c/Program Files/nodejs//npm</span><br></pre></td></tr></table></figure><p>第一条是npm在WSL中的位置，第二条是npm在Windows中的位置（取决于你安装时选择的位置）</p><hr><h3 id="添加环境变量"><a href="#添加环境变量" class="headerlink" title="添加环境变量"></a>添加环境变量</h3><p>因为我用的是zsh，说一下如何添加</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi ~/.zshrc</span><br></pre></td></tr></table></figure><p>在 .zshrc 添加一行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:usr/bin</span><br></pre></td></tr></table></figure><p>然后用 source 命令刷新一下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> ~/.zshrc</span><br></pre></td></tr></table></figure><p><em>如果你使用的是bash可能不需要添加环境变量这一步</em></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.jianshu.com/p/a480b99741f6" target="_blank" rel="noopener">Ubuntu/debian系安装nodejs环境</a></p><p><a href="https://www.jianshu.com/p/48c022928771" target="_blank" rel="noopener">zsh添加环境变量</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;环境简介&quot;&gt;&lt;a href=&quot;#环境简介&quot; class=&quot;headerlink&quot; title=&quot;环境简介&quot;&gt;&lt;/a&gt;环境简介&lt;/h2&gt;&lt;h3 id=&quot;系统环境&quot;&gt;&lt;a href=&quot;#系统环境&quot; class=&quot;headerlink&quot; title=&quot;系统环境&quot;&gt;&lt;/a
      
    
    </summary>
    
    
      <category term="Deploy" scheme="http://blog.iavjkaede.com/categories/Deploy/"/>
    
    
      <category term="WSL" scheme="http://blog.iavjkaede.com/tags/WSL/"/>
    
      <category term="Debian" scheme="http://blog.iavjkaede.com/tags/Debian/"/>
    
      <category term="Npm" scheme="http://blog.iavjkaede.com/tags/Npm/"/>
    
      <category term="Nodejs" scheme="http://blog.iavjkaede.com/tags/Nodejs/"/>
    
  </entry>
  
  <entry>
    <title>NetCore 使用 ImageSharp 为图片添加水印</title>
    <link href="http://blog.iavjkaede.com/2020/05/18/NetCore%20ImageSharp%20Watermark/"/>
    <id>http://blog.iavjkaede.com/2020/05/18/NetCore%20ImageSharp%20Watermark/</id>
    <published>2020-05-18T15:22:37.125Z</published>
    <updated>2020-05-23T08:52:22.087Z</updated>
    
    <content type="html"><![CDATA[<h2 id="环境简介"><a href="#环境简介" class="headerlink" title="环境简介"></a>环境简介</h2><h3 id="系统环境"><a href="#系统环境" class="headerlink" title="系统环境"></a>系统环境</h3><p>Windows10 1903</p><h3 id="NetCore-SDK-版本"><a href="#NetCore-SDK-版本" class="headerlink" title=".NetCore SDK 版本"></a>.NetCore SDK 版本</h3><p>.NetCore 2.2</p><h3 id="ImageSharp-版本"><a href="#ImageSharp-版本" class="headerlink" title="ImageSharp 版本"></a>ImageSharp 版本</h3><p>SixLabors.ImageSharp  1.0.0-beta0006</p><h2 id="1-安装ImageSharp-Nuget-包"><a href="#1-安装ImageSharp-Nuget-包" class="headerlink" title="1.安装ImageSharp Nuget 包"></a>1.安装ImageSharp Nuget 包</h2><p>我写这篇博客时，ImageSharp还没有一个正式的发布版本，所以这里使用的是预览版本。</p><p>如果通过Visual Studio 安装Nuget 包，记得勾选<strong>包含预发行版本</strong>。如果不知道ImageSharp 是什么，可以先百度一下。</p><p><a href="https://github.com/SixLabors/ImageSharp" target="_blank" rel="noopener">ImageSharp 项目的 github 地址</a></p><p>通过CLR 安装ImageSharp</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet add <span class="string">'项目名称'</span> package SixLabors.ImageSharp --version 1.0.0-beta0006</span><br></pre></td></tr></table></figure><h2 id="2-编写添加水印的代码"><a href="#2-编写添加水印的代码" class="headerlink" title="2. 编写添加水印的代码"></a>2. 编写添加水印的代码</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Stream <span class="title">Watermark</span>(<span class="params">Stream origin, Stream mark, <span class="keyword">string</span> position, <span class="keyword">float</span> scale, <span class="keyword">float</span> opacity</span>)</span></span><br><span class="line"><span class="function"></span> &#123;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// <span class="doctag">TODO:</span> 参数校验</span></span><br><span class="line">     <span class="comment">// origin mark 不可空，</span></span><br><span class="line">     <span class="comment">// position 可指定默认值</span></span><br><span class="line">     <span class="comment">// scale opacity 不可小于等于0</span></span><br><span class="line"></span><br><span class="line">     <span class="keyword">using</span>(<span class="keyword">var</span> originImage = Image.Load(origin))</span><br><span class="line">     &#123;</span><br><span class="line">         <span class="keyword">using</span>(<span class="keyword">var</span> markImage = Image.Load(mark))</span><br><span class="line">         &#123;</span><br><span class="line">             <span class="comment">// 设置水印的大小，如果图片宽大于高， scale缩放的是水印图的宽度，否则将应用到高度上</span></span><br><span class="line">             <span class="keyword">float</span> markWidth = originImage.Width * scale;</span><br><span class="line">             <span class="keyword">if</span> (originImage.Width &lt; originImage.Height)</span><br><span class="line">                 markWidth = originImage.Height * scale;</span><br><span class="line"></span><br><span class="line">             <span class="comment">// 对水印图片进行等比缩放</span></span><br><span class="line">             <span class="keyword">float</span> ratio = markWidth / markImage.Width;</span><br><span class="line">             <span class="keyword">float</span> markHeight = markImage.Height * ratio;</span><br><span class="line"></span><br><span class="line">             markImage.Mutate(mk =&gt;</span><br><span class="line">                 mk.Resize((<span class="keyword">int</span>)markWidth, (<span class="keyword">int</span>)markHeight)</span><br><span class="line"></span><br><span class="line">             );</span><br><span class="line"></span><br><span class="line">             <span class="comment">// 根据position 计算水印位置  </span></span><br><span class="line">             <span class="comment">// position可能的值如下 "left top botom center right"</span></span><br><span class="line">             <span class="comment">// 这些值可以进行组合 如果同一方向有重复值，后面的会覆盖掉前面的 </span></span><br><span class="line">             <span class="comment">// 按照 中左上右下的顺序处理</span></span><br><span class="line">             position = position.ToLower();</span><br><span class="line">             Point point = <span class="keyword">new</span> Point();</span><br><span class="line"></span><br><span class="line">             <span class="keyword">if</span> (position.Contains(<span class="string">"center"</span>))</span><br><span class="line">             &#123;</span><br><span class="line">                 point.X = (originImage.Width - markImage.Width) / <span class="number">2</span>;</span><br><span class="line">                 point.Y = (originImage.Height - markImage.Height) / <span class="number">2</span>;</span><br><span class="line">             &#125;</span><br><span class="line"></span><br><span class="line">             <span class="keyword">if</span> (position.Contains(<span class="string">"left"</span>))</span><br><span class="line">                 point.X = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">             <span class="keyword">if</span> (position.Contains(<span class="string">"top"</span>))</span><br><span class="line">                 point.Y = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">             <span class="keyword">if</span> (position.Contains(<span class="string">"right"</span>))</span><br><span class="line">                 point.X = originImage.Width - markImage.Width;</span><br><span class="line"></span><br><span class="line">             <span class="keyword">if</span> (position.Contains(<span class="string">"bottom"</span>))</span><br><span class="line">                 point.Y = originImage.Height - markImage.Height;</span><br><span class="line"></span><br><span class="line">             <span class="comment">// 把水印加到图片上</span></span><br><span class="line">             originImage.Mutate(oi =&gt;</span><br><span class="line">             &#123;</span><br><span class="line">                 oi.DrawImage(markImage, point, opacity);</span><br><span class="line">             &#125;);</span><br><span class="line"></span><br><span class="line">             origin.Position = <span class="number">0</span>;</span><br><span class="line">             <span class="keyword">var</span> format  = Image.DetectFormat(origin);</span><br><span class="line">             <span class="keyword">var</span> encoder = Configuration.Default.ImageFormatsManager.FindEncoder(format);</span><br><span class="line">             <span class="keyword">var</span> outStream = <span class="keyword">new</span> MemoryStream();</span><br><span class="line"></span><br><span class="line">             originImage.Save(outStream, encoder);</span><br><span class="line">             origin.Position    = <span class="number">0</span>;</span><br><span class="line">             mark.Position      = <span class="number">0</span>;</span><br><span class="line">             outStream.Position = <span class="number">0</span>;</span><br><span class="line">             <span class="keyword">return</span> outStream;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>ImageSharp 的使用起来很简单方便，有关更多使用ImageSharp的细节，可以参考<a href="https://docs.sixlabors.com/articles/ImageSharp/GettingStarted.html" target="_blank" rel="noopener">ImageSharp 的文档</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;环境简介&quot;&gt;&lt;a href=&quot;#环境简介&quot; class=&quot;headerlink&quot; title=&quot;环境简介&quot;&gt;&lt;/a&gt;环境简介&lt;/h2&gt;&lt;h3 id=&quot;系统环境&quot;&gt;&lt;a href=&quot;#系统环境&quot; class=&quot;headerlink&quot; title=&quot;系统环境&quot;&gt;&lt;/a
      
    
    </summary>
    
    
      <category term=".NET" scheme="http://blog.iavjkaede.com/categories/NET/"/>
    
    
      <category term=".NET" scheme="http://blog.iavjkaede.com/tags/NET/"/>
    
      <category term="Image" scheme="http://blog.iavjkaede.com/tags/Image/"/>
    
  </entry>
  
  <entry>
    <title>.NetCore Web 项目的插件实现</title>
    <link href="http://blog.iavjkaede.com/2020/05/18/NetCore%20Web%20Plugins/"/>
    <id>http://blog.iavjkaede.com/2020/05/18/NetCore%20Web%20Plugins/</id>
    <published>2020-05-18T15:22:37.125Z</published>
    <updated>2020-06-21T13:19:43.247Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>为什么使用插件的方式去完成项目？并不是因为这很酷，仅仅是，我们希望项目变得更容易维护，更容易拓展，彼此之间的依赖更清晰更简单。使用插件，我们可以在不影响现有功能情况下去开发新的功能，随意替换现有的功能模块，连重新编译都不需要。看起来确实挺酷，这么酷的功能，在C#中实现起来却并不复杂。嗯，那就分享一下我在.NetCore 项目中使用插件的方式。</p><h2 id="环境简介"><a href="#环境简介" class="headerlink" title="环境简介"></a>环境简介</h2><h3 id="系统环境"><a href="#系统环境" class="headerlink" title="系统环境"></a>系统环境</h3><p>Windows 10 LTSC 2019</p><h3 id="开发环境"><a href="#开发环境" class="headerlink" title="开发环境"></a>开发环境</h3><p>SDK： .NetCore 2.2</p><p>Database：SQLite 3</p><h3 id="开发工具"><a href="#开发工具" class="headerlink" title="开发工具"></a>开发工具</h3><p>Editor：Visual Studio Code</p><p>Shell：Powershell</p><h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><h3 id="项目准备"><a href="#项目准备" class="headerlink" title="项目准备"></a>项目准备</h3><p>使用以下命令去创建以下项目。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mkdir PluginDemo</span><br><span class="line">cd PluginDemo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保证使用的是2.2版本的.netcore sdk</span></span><br><span class="line"><span class="comment"># 使用 dotnet --list-sdks 查看已安装的.netcore 版本</span></span><br><span class="line">dotnet new global.json -<span class="literal">-sdk</span><span class="literal">-version</span> <span class="number">2.2</span>.<span class="number">204</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建项目</span></span><br><span class="line">dotnet new web <span class="literal">-o</span> Host</span><br><span class="line">dotnet new classlib <span class="literal">-o</span> Share</span><br><span class="line">dotnet new classlib <span class="literal">-o</span> Plugin1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加引用</span></span><br><span class="line">dotnet add .\Host\ reference .\Share\</span><br><span class="line">dotnet add .\Plugin1\ reference .\Share\</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 VS Code 中打开</span></span><br><span class="line">code ./</span><br></pre></td></tr></table></figure><p>按下<code>F5</code>进行调试，保证项目成功启动。</p><p>这里创建了三个项目，分别是<strong>Host</strong>、<strong>Plugin1</strong>、<strong>Share</strong>，依赖关系如下</p><p>Host &lt;- Share</p><p>Plugin1 &lt;- Share</p><h3 id="数据库准备"><a href="#数据库准备" class="headerlink" title="数据库准备"></a>数据库准备</h3><p>在真正开始之前，最好部署一个可用的数据库，因为后面的Model映射会用到。</p><h2 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h2><p>准备好了吗？准备好那可就开始了。🚀</p><h3 id="加载Controller"><a href="#加载Controller" class="headerlink" title="加载Controller"></a>加载Controller</h3><p>首先要做到的一点就是，把编写的程序集（其中包含继承自Controller的子类）丢到定义的插件目录，重启应用后，程序集中的Controller能够被成功路由。</p><p>废话不多说，用<strong>ApplicationPart</strong>来实现这一点。</p><h4 id="修改Startup-cs"><a href="#修改Startup-cs" class="headerlink" title="修改Startup.cs*"></a>修改Startup.cs*</h4><p>项目 – <strong>Host</strong></p><p>编辑<strong>Startup.cs</strong> 中的<code>ConfigureServices</code>方法中使用以下代码配置MVC</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    .....</span><br><span class="line">        </span><br><span class="line">    services.AddMvc().ConfigureApplicationPartManager(manager =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">string</span> path = Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location);</span><br><span class="line">        <span class="keyword">var</span> assmeblyFiles = Directory.GetFiles (path, <span class="string">"*.dll"</span>);</span><br><span class="line">        assmeblyFiles.Select(AssemblyLoadContext.Default.LoadFromAssemblyPath)</span><br><span class="line">            .ToList().ForEach(assmebly =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (assmebly.GetTypes().Any(<span class="keyword">typeof</span>(Controller).IsAssignableFrom))</span><br><span class="line">                &#123;</span><br><span class="line">                        AssemblyPart part = <span class="keyword">new</span> AssemblyPart(assmebly);</span><br><span class="line">                        manager.ApplicationParts.Add(part);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    .....</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">IApplicationBuilder app, IHostingEnvironment env</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (env.IsDevelopment())</span><br><span class="line">    &#123;</span><br><span class="line">        app.UseDeveloperExceptionPage();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    app.Run(async (context) =&gt;</span></span><br><span class="line"><span class="comment">    &#123;</span></span><br><span class="line"><span class="comment">        await context.Response.WriteAsync("Hello World!");</span></span><br><span class="line"><span class="comment">    &#125;);*/</span></span><br><span class="line">    app.UseMvc();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‘*.dll’ 可以用如 *.plugin.dll 这样的字符串代替，取一个插件命名规则。最好把这个规则放在配置文件中。</p><p>接下来编写一个Controller进行测试。</p><hr><p>项目 – <strong>Plugin1</strong></p><h4 id="添加PluginController-cs"><a href="#添加PluginController-cs" class="headerlink" title="添加PluginController.cs"></a>添加<strong>PluginController.cs</strong></h4><p><strong>PluginController.cs</strong></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Plugin1</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">ApiController</span>]</span><br><span class="line">    [<span class="meta">Route (<span class="meta-string">"api/[controller]/[action]"</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PluginController</span> : <span class="title">Controller</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">PluginController</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">Ping</span>(<span class="params"></span>)</span> =&gt; <span class="string">"pong"</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编写完之后还需要添加MVC的NuGet包。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet add .\Plugin1\ package Microsoft.AspNetCore.Mvc</span><br></pre></td></tr></table></figure><p>完成NuGet包添加后就可以构建Plugin1项目了。</p><hr><h4 id="编写tasks-json"><a href="#编写tasks-json" class="headerlink" title="编写tasks.json"></a>编写tasks.json</h4><p>等等，如果不想每次都<code>dotnet build .\Plugin1\</code>，还需要配置下<strong>tasks.json</strong></p><p>第一次<code>F5</code>调试的时候会配置构建任务生成该文件。</p><p><strong>tasks.json</strong>中默认添加了三个任务<code>build，publish，watch</code>，现在添加<strong>Plugin1</strong>的构建任务。</p><p>编辑<strong>tasks.json</strong> 加入以下内容</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"label"</span>: <span class="string">"build plugin1"</span>,</span><br><span class="line">    <span class="attr">"command"</span>: <span class="string">"dotnet"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"process"</span>,</span><br><span class="line">    <span class="attr">"args"</span>: [</span><br><span class="line">        <span class="string">"build"</span>,</span><br><span class="line">        <span class="string">"$&#123;workspaceFolder&#125;/Plugin1/Plugin1.csproj"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"problemMatcher"</span>: <span class="string">"$tsc"</span></span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"label"</span>: <span class="string">"build &amp; install plugin1"</span>,</span><br><span class="line">    <span class="attr">"command"</span>: <span class="string">"cp"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"shell"</span>,</span><br><span class="line">    <span class="attr">"args"</span>: [</span><br><span class="line">        <span class="string">"$&#123;workspaceFolder&#125;/Plugin1/bin/Debug/netstandard2.0/Plugin1.dll"</span>,</span><br><span class="line">        <span class="string">"$&#123;workspaceFolder&#125;/Host/bin/Debug/netcoreapp2.2/Plugin1.dll"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"windows"</span>: &#123;</span><br><span class="line">        <span class="attr">"command"</span>: <span class="string">"xcopy"</span>,</span><br><span class="line">        <span class="attr">"args"</span>: [</span><br><span class="line">            <span class="string">"/y"</span>,</span><br><span class="line">            <span class="string">"$&#123;workspaceFolder&#125;\\Plugin1\\bin\\Debug\\netstandard2.0\\Plugin1.dll"</span>,</span><br><span class="line">            <span class="string">"$&#123;workspaceFolder&#125;\\Host\\bin\\Debug\\netcoreapp2.2\\Plugin1.dll"</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"dependsOn"</span>: [</span><br><span class="line">        <span class="string">"build plugin1"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"problemMatcher"</span>: <span class="string">"$tsc"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在VS Code中执行任务<strong>build &amp; install plugin1</strong> </p><p><code>ctrl+shift+p</code>  输入 <code>run task</code> 选择 <code>build &amp; install plugin1</code></p><p><em>注意，第一次运行命令可能会询问是复制的文件还是文件夹，在任务终端中，输入<code>F</code>确定是文件即可。</em></p><p>执行成功后在<strong>Host</strong>的<code>bin/Debug/netcoreapp2.2</code>目录下瞄一眼有没有Plugin1.dll，有的话就👌。</p><hr><h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><p><code>F5</code>启动项目，然后在浏览器输入<a href="https://5001/api/plugin/ping。" target="_blank" rel="noopener">https://5001/api/plugin/ping。</a></p><p>当看到浏览器回复了一个’pong’ 之后，意味着，成功了😀。</p><h3 id="注入Services"><a href="#注入Services" class="headerlink" title="注入Services"></a>注入Services</h3><p>Plugin1.dll 除了需要响应请求之外，它还需要使用IOC容器进行DI。.NetCore 已经内置了IOC容器，需要解决的问题就是：怎么把这个容器传递给插件🤔。这里使用反射来完成它。</p><p>思路是这样，定义一个用来注入服务的接口。在<strong>Host</strong>项目中，需要遍历所有实现了该接口的程序集并调用注入方法，然后在插件项目中实现该接口。当然，这个接口需要放在<strong>Share</strong>项目中。</p><h4 id="用来注入的接口"><a href="#用来注入的接口" class="headerlink" title="用来注入的接口*"></a>用来注入的接口*</h4><p>项目 – <strong>Share</strong></p><p>在VS Code 中新建<strong>IServicesRegister.cs</strong></p><p><strong>IServicesRegister.cs</strong></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.Extensions.DependencyInjection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Share</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IServicesRegister</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">RegisterServices</span>(<span class="params">IServiceCollection services</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里还需要添加<strong>Microsoft.Extensions.DependencyInjection</strong> NuGet 包。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet add .\Share\ package Microsoft.Extensions.DependencyInjection</span><br></pre></td></tr></table></figure><p><em>命令是在<strong>PluginDemo</strong> 路径下执行的，可不要混了。</em></p><p>这个接口极其简单，只有一个<code>RegisterServices</code>的方法，我这里保证这个接口有且只有这一个方法，方便待会能找到它。</p><hr><h4 id="完成注入"><a href="#完成注入" class="headerlink" title="完成注入*"></a>完成注入*</h4><p>现在在<strong>Startup.cs</strong>中添加一个<code>RegisterServices</code>方法（名字是和接口的重复的，这没关系，不要混淆了即可）,或者可以直接<code>ConfigureServices</code> 中操作。</p><p><strong>Startup.cs</strong></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 最好是在最后一步去注入这些服务</span></span><br><span class="line">    RegisterServices(services);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RegisterServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 查找dll文件</span></span><br><span class="line">    <span class="keyword">var</span> dllFiles = Directory.GetFiles(Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location), <span class="string">"*.dll"</span>);</span><br><span class="line">    <span class="comment">// 查找程序集</span></span><br><span class="line">    <span class="keyword">var</span> assemblies = dllFiles.Select(AssemblyLoadContext.Default.LoadFromAssemblyPath).ToList();</span><br><span class="line">    assemblies.ForEach(ass =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 获取实现IServiceRegister 接口的类型</span></span><br><span class="line">        <span class="keyword">var</span> registers = ass.GetTypes().Where(m =&gt; m.IsClass &amp;&amp; <span class="keyword">typeof</span>(IServicesRegister).IsAssignableFrom(m)).ToList();</span><br><span class="line">        registers.ForEach(reg =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> instance = Activator.CreateInstance(reg);</span><br><span class="line">            <span class="comment">// 方法 保证该接口仅有一个方法的情况下，使用SingleOrDefault，应该用Single。</span></span><br><span class="line">            <span class="keyword">var</span> method = <span class="keyword">typeof</span>(IServicesRegister).GetMethods().SingleOrDefault();</span><br><span class="line">            </span><br><span class="line">            method.Invoke(instance, <span class="keyword">new</span> <span class="keyword">object</span>[]</span><br><span class="line">            &#123;</span><br><span class="line">                services</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure><hr><h4 id="编写Service进行测试"><a href="#编写Service进行测试" class="headerlink" title="编写Service进行测试"></a>编写Service进行测试</h4><p>项目 – <strong>Plugin1</strong></p><p>需要添加三个文件</p><ul><li>ServicesRegister.cs</li><li>IAddService.cs</li><li>AddService.cs</li></ul><p><strong>ServicesRegister.cs</strong> 用来实现注入，<strong>AddService.cs</strong> 将实现 IAddService 接口用来测试。</p><p><strong>ServicesRegister.cs</strong> </p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Diagnostics;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.DependencyInjection;</span><br><span class="line"><span class="keyword">using</span> Share;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Plugin1</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ServicesRegister</span> : <span class="title">IServicesRegister</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RegisterServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Debug.WriteLine(<span class="string">"Register plugin1's services"</span>, <span class="string">"info: "</span>);</span><br><span class="line"></span><br><span class="line">            services.AddTransient&lt;IAddService,AddService&gt;();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>IAddService.cs</strong></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Plugin1</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IAddService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">string</span> <span class="title">Add</span>(<span class="params"><span class="keyword">string</span> a, <span class="keyword">string</span> b</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>AddService.cs</strong></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Plugin1</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AddService</span> : <span class="title">IAddService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">Add</span>(<span class="params"><span class="keyword">string</span> a, <span class="keyword">string</span> b</span>)</span> =&gt; a + b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后修改<strong>PluginController.cs</strong> 添加AddService的注入依赖和测试方法。</p><p><strong>PluginController.cs</strong></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Plugin1</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">ApiController</span>]</span><br><span class="line">    [<span class="meta">Route(<span class="meta-string">"api/[controller]/[action]"</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PluginController</span> : <span class="title">Controller</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">readonly</span> IAddService m_addService;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">PluginController</span>(<span class="params">IAddService addService</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            m_addService = addService;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">Ping</span>(<span class="params"></span>)</span> =&gt; <span class="string">"pong"</span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">PingService</span>(<span class="params"><span class="keyword">string</span> a, <span class="keyword">string</span> b</span>)</span> =&gt; m_addService.Add(a, b);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="启动-1"><a href="#启动-1" class="headerlink" title="启动"></a>启动</h4><p>先执行 <code>build &amp; install plugin1</code>命令，然后<code>F5</code>启动。🚀</p><p>一切完成，在浏览器地址栏输入<a href="https://localhost:5001/api/plugin/pingservice?a=service&amp;b=done。" target="_blank" rel="noopener">https://localhost:5001/api/plugin/pingservice?a=service&amp;b=done。</a></p><p>看看浏览器响应，是否把’service’ 和 ‘done’ 拼到一起了呢。</p><p>再去调试控制台看打印的<code>Debug.WriteLine(&quot;Register plugin1&#39;s services&quot;, &quot;info: &quot;);</code> 有没有正确输出。👏👏👏</p><h3 id="独立配置文件"><a href="#独立配置文件" class="headerlink" title="独立配置文件"></a>独立配置文件</h3><p>当决定让插件成为一个完整独立的功能模块时，插件应该使用独立的配置文件，配置过程和普通的项目配置没有太大区别，这里就简单讲一下。</p><p>项目 – <strong>Plugin1</strong></p><p>添加以下两个文件</p><ul><li>plugin1.json</li><li>Plugin1Config.cs</li></ul><h4 id="ServicesRegister-cs中配Config"><a href="#ServicesRegister-cs中配Config" class="headerlink" title="ServicesRegister.cs中配Config*"></a><strong>ServicesRegister.cs</strong>中配Config*</h4><p>修改<strong>ServicesRegister.cs</strong> 中 方法  <em>RegisterServices</em>  如下</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ServicesRegister</span> : <span class="title">IServicesRegister</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RegisterServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line"><span class="function"></span>       &#123;</span><br><span class="line">           Debug.WriteLine(<span class="string">"Register plugin1's services"</span>, <span class="string">"info: "</span>);</span><br><span class="line"><span class="comment">// 路径可以自行配置</span></span><br><span class="line">           <span class="keyword">var</span> config = <span class="keyword">new</span> ConfigurationBuilder()</span><br><span class="line">               .SetBasePath(Directory.GetCurrentDirectory())</span><br><span class="line">               .AddJsonFile(<span class="string">"plugin1.json"</span>, <span class="literal">false</span>)</span><br><span class="line">               .Build();</span><br><span class="line"></span><br><span class="line">           services.Configure&lt;Plugin1Config&gt;(config.GetSection(<span class="keyword">nameof</span>(Plugin1Config)));</span><br><span class="line"></span><br><span class="line">           services.AddTransient&lt;IAddService, AddService&gt;();</span><br><span class="line"></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h4 id="Plugin1Config-cs"><a href="#Plugin1Config-cs" class="headerlink" title="Plugin1Config.cs"></a>Plugin1Config.cs</h4><p><strong>Plugin1Config.cs</strong></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Plugin1</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Plugin1Config</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Name</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span>;</span><br><span class="line">            <span class="keyword">set</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Version</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span>;</span><br><span class="line">            <span class="keyword">set</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Author</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span>;</span><br><span class="line">            <span class="keyword">set</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="添加配置文件"><a href="#添加配置文件" class="headerlink" title="添加配置文件"></a>添加配置文件</h4><p><strong>plugin1.json</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"Plugin1Config"</span>:&#123;</span><br><span class="line">        <span class="attr">"Name"</span>:<span class="string">"Plugin1"</span>,</span><br><span class="line">        <span class="attr">"Version"</span>:<span class="string">"1.1"</span>,</span><br><span class="line">        <span class="attr">"Author"</span>:<span class="string">"Your Name"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>想要成功构建<strong>Plugin1</strong>项目还需要添加以下NuGet包</p><ul><li>Microsoft.Extensions.Configuration</li><li>Microsoft.Extensions.Configuration.FileExtensions</li><li>Microsoft.Extensions.Configuration.Json</li><li>Microsoft.Extensions.Options.ConfigurationExtensions</li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dotnet add .\Plugin1\ package  Microsoft.Extensions.Configuration</span><br><span class="line">dotnet add .\Plugin1\ package  Microsoft.Extensions.Configuration.FileExtensions</span><br><span class="line">dotnet add .\Plugin1\ package  Microsoft.Extensions.Configuration.Json</span><br><span class="line">dotnet add .\Plugin1\ package  Microsoft.Extensions.Options.ConfigurationExtensions</span><br></pre></td></tr></table></figure><hr><p>项目 – <strong>Host</strong></p><p>另外 ，<strong>Host</strong> 中还需要在<strong>Startup.cs</strong>文件 <em>ConfigureServices</em>  方法中加上一行</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">services.AddOptions();</span><br></pre></td></tr></table></figure><hr><h4 id="测试配置"><a href="#测试配置" class="headerlink" title="测试配置"></a>测试配置</h4><p>emmm，Controller的代码看起来是这样。</p><p><strong>PluginController.cs</strong></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Options;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Plugin1</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">ApiController</span>]</span><br><span class="line">    [<span class="meta">Route(<span class="meta-string">"api/[controller]/[action]"</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PluginController</span> : <span class="title">Controller</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">readonly</span> IAddService m_addService;</span><br><span class="line">        <span class="keyword">readonly</span> Plugin1Config m_config;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">PluginController</span>(<span class="params">IAddService addService, IOptions&lt;Plugin1Config&gt; options</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            m_addService = addService;</span><br><span class="line">            m_config = options.Value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">Ping</span>(<span class="params"></span>)</span> =&gt; <span class="string">"pong"</span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">PingService</span>(<span class="params"><span class="keyword">string</span> a, <span class="keyword">string</span> b</span>)</span> =&gt; m_addService.Add(a, b);</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ActionResult&lt;Plugin1Config&gt; <span class="title">PingConfig</span>(<span class="params"></span>)</span> =&gt; m_config;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>添加NuGet引用</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet add .\Plugin1\ package  Microsoft.Extensions.Options</span><br></pre></td></tr></table></figure><hr><h4 id="启动-2"><a href="#启动-2" class="headerlink" title="启动"></a>启动</h4><p>现在像之前那样构建项目，在启动项目之前，把<strong>Plugin1</strong>的配置文件<strong>plugin1.json</strong>拷贝到<strong>Host</strong>目录下。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里我配置的是当前目录</span></span><br><span class="line"><span class="keyword">var</span> config = <span class="keyword">new</span> ConfigurationBuilder()</span><br><span class="line">                .SetBasePath(Directory.GetCurrentDirectory())</span><br><span class="line">                .AddJsonFile(<span class="string">"plugin1.json"</span>, <span class="literal">false</span>)</span><br><span class="line">                .Build();</span><br></pre></td></tr></table></figure><p>启动之后，在浏览器地址栏输入<a href="https://localhost:5001/api/plugin/pingconfig。" target="_blank" rel="noopener">https://localhost:5001/api/plugin/pingconfig。</a></p><p>看看有没有正常读取到配置。🙂</p><h3 id="映射Model"><a href="#映射Model" class="headerlink" title="映射Model"></a>映射Model</h3><p>在插件中完成某些拓展功能时，可能需要数据库的表结构支持，但是，我不想把插件中的Model放到<strong>Share</strong>项目中，插件应该自己管理自己的Model。（究竟是放在Share中还是放在插件项目中，具体需要看插件的定位）</p><p>需要准备一个数据库环境，我这里使用SQLite。</p><h4 id="数据库表结构"><a href="#数据库表结构" class="headerlink" title="数据库表结构"></a>数据库表结构</h4><p>表名 <em>t_plugdata</em></p><ul><li>Id</li><li>Name</li><li>Data</li></ul><p>任意加一些数据进去，比如</p><table><thead><tr><th>Id</th><th>Name</th><th>Data</th></tr></thead><tbody><tr><td>1</td><td>Ok</td><td>true</td></tr><tr><td>2</td><td>Pity</td><td>I am ok</td></tr><tr><td>3</td><td>Lisa</td><td>Hi,I am here</td></tr></tbody></table><p>保证有点数据就好了，有关数据库链接字符串或者其他涉及的东西不在这里细讲。</p><h4 id="配置数据库上下文"><a href="#配置数据库上下文" class="headerlink" title="配置数据库上下文*"></a>配置数据库上下文*</h4><p>项目 – <strong>Share</strong></p><p>添加<strong>HostDbContext.cs</strong></p><p><strong>HostDbContext.cs</strong></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Loader;</span><br><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Share</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HostDbContext</span> : <span class="title">DbContext</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">HostDbContext</span>(<span class="params">DbContextOptions options</span>) : <span class="title">base</span>(<span class="params">options</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line"> </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnModelCreating</span>(<span class="params">ModelBuilder modelBuilder</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">base</span>.OnModelCreating(modelBuilder);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 依旧是使用反射的方式去完成</span></span><br><span class="line">            <span class="keyword">var</span> dllfiles = Directory.GetFiles(Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location), <span class="string">"*.dll"</span>);</span><br><span class="line">            Array.ForEach(dllfiles, files =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> assembly = AssemblyLoadContext.Default.LoadFromAssemblyPath(files);</span><br><span class="line">                assembly.GetTypes().Where(type =&gt; type.GetInterface(<span class="keyword">typeof</span>(IEntityTypeConfiguration&lt;&gt;).FullName) != <span class="literal">null</span>)</span><br><span class="line">                    .ToList().ForEach(type =&gt;</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">dynamic</span> instance = Activator.CreateInstance(type);</span><br><span class="line">                        modelBuilder.ApplyConfiguration(instance);</span><br><span class="line">                    &#125;);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnConfiguring</span>(<span class="params">DbContextOptionsBuilder optionsBuilder</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!optionsBuilder.IsConfigured)</span><br><span class="line">            &#123;</span><br><span class="line">                optionsBuilder.UseSqlite(<span class="string">"Data Source=./HostDb.db"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>构建<strong>Share</strong>项目可能用到的NuGet 包</p><ul><li>Microsoft.EntityFrameworkCore</li><li>Microsoft.EntityFrameworkCore.SQLite</li><li>System.Runtime.Loader</li><li>System.Linq</li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dotnet add .\Share\ package  Microsoft.EntityFrameworkCore</span><br><span class="line">dotnet add .\Share\ package  Microsoft.EntityFrameworkCore.SQLite</span><br><span class="line">dotnet add .\Share\ package  System.Runtime.Loader</span><br><span class="line">dotnet add .\Share\ package  System.Linq</span><br></pre></td></tr></table></figure><h4 id="映射Model-并实现-IEntiyTypeConfigration"><a href="#映射Model-并实现-IEntiyTypeConfigration" class="headerlink" title="映射Model 并实现 IEntiyTypeConfigration*"></a>映射Model 并实现 IEntiyTypeConfigration*</h4><p>项目 – <strong>Plugin1</strong></p><p>添加文件 <strong>PluginData.cs</strong></p><p><strong>PluginData.cs</strong></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.ComponentModel.DataAnnotations.Schema;</span><br><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore.Metadata.Builders;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Plugin1</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Table(<span class="meta-string">"t_plugdata"</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PluginData</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Id</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span>;</span><br><span class="line">            <span class="keyword">set</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Name</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span>;</span><br><span class="line">            <span class="keyword">set</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Data</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span>;</span><br><span class="line">            <span class="keyword">set</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public class PluginDataConfig : IEntityTypeConfiguration&lt;PluginData&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">EntityTypeBuilder&lt;PluginData&gt; builder</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            builder.ToTable(<span class="string">"t_plugdata"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>构建Plugin1 需要添加的NuGet 包</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet add .\Plugin1\ package  Microsoft.EntityFrameworkCore</span><br></pre></td></tr></table></figure><h4 id="注入数据库上下文"><a href="#注入数据库上下文" class="headerlink" title="注入数据库上下文"></a>注入数据库上下文</h4><p>项目 – <strong>Host</strong></p><p><strong>Host</strong> 中还需要在<strong>Startup.cs</strong>文件 <em>ConfigureServices</em>  方法中加上一行</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">services.AddDbContext&lt;HostDbContext&gt;();</span><br></pre></td></tr></table></figure><h4 id="测试数据库上下文"><a href="#测试数据库上下文" class="headerlink" title="测试数据库上下文"></a>测试数据库上下文</h4><p>在<strong>PluginController.cs</strong>中进行注入和测试。</p><p><strong>PluginController.cs</strong></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Options;</span><br><span class="line"><span class="keyword">using</span> Share;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Plugin1</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">ApiController</span>]</span><br><span class="line">    [<span class="meta">Route(<span class="meta-string">"api/[controller]/[action]"</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PluginController</span> : <span class="title">Controller</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">readonly</span> IAddService m_addService;</span><br><span class="line">        <span class="keyword">readonly</span> Plugin1Config m_config;</span><br><span class="line">        <span class="keyword">readonly</span> HostDbContext m_dbContext;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">PluginController</span>(<span class="params">IAddService addService,</span></span></span><br><span class="line"><span class="function"><span class="params">            IOptions&lt;Plugin1Config&gt; options,</span></span></span><br><span class="line"><span class="function"><span class="params">            HostDbContext dbContext</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            m_addService = addService;</span><br><span class="line">            m_config = options.Value;</span><br><span class="line">            m_dbContext = dbContext;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">Ping</span>(<span class="params"></span>)</span> =&gt; <span class="string">"pong"</span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">PingService</span>(<span class="params"><span class="keyword">string</span> a, <span class="keyword">string</span> b</span>)</span> =&gt; m_addService.Add(a, b);</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ActionResult&lt;Plugin1Config&gt; <span class="title">PingConfig</span>(<span class="params"></span>)</span> =&gt; Json(m_config);</span><br><span class="line">        <span class="keyword">public</span> ActionResult&lt;List&lt;PluginData&gt;&gt; PingDb() =&gt; m_dbContext.Set&lt;PluginData&gt;().ToList();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可能需要添加的NuGet包</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet add .\Plugin1\  package  System.Linq</span><br></pre></td></tr></table></figure><p>可以说是终于完成最后一步了。</p><p>最后一步？我还想补充一点。</p><p><strong>PluginController</strong> <em>PingDb</em> 方法中用<code>m_dbContext.Set&lt;PluginData&gt;()</code>这种方法使用HostDbContext，为了方便使用，可以写一个HostDbContext的拓展类。大概像这个样子</p><p><strong>HostDbContextExtensions.cs</strong></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"><span class="keyword">using</span> Share;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Plugin1</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">HostDbContextExtensitions</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DbSet&lt;PluginData&gt; <span class="title">PluginDatas</span>(<span class="params"><span class="keyword">this</span> HostDbContext context</span>)</span> =&gt; context.Set&lt;PluginData&gt;();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>emmm，这次是完结了。</p><h4 id="启动-3"><a href="#启动-3" class="headerlink" title="启动"></a>启动</h4><p>构建插件，然后启动项目。</p><p>在浏览器地址栏输入<a href="https://localhost:5001/api/plugin/pingdb。" target="_blank" rel="noopener">https://localhost:5001/api/plugin/pingdb。</a><br>怎么样，有结果了吗？👀</p><h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>我的个人观点。</p><p>我觉得可以从两个方向去使用插件</p><ol><li>Host项目功能完备，插件只是拓展功能。</li><li>Host项目完全依赖插件实现功能</li></ol><p>混合使用这两种方式也好，单单只用其中一个方式也好。都没问题，具体取决于手中的键盘，不是么。</p><p>还有一点，.NetCore 中已经没有AppDomain的概念了，插件无法实现热插拔。</p><p>完结👌。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;为什么使用插件的方式去完成项目？并不是因为这很酷，仅仅是，我们希望项目变得更容易维护，更容易拓展，彼此之间的依赖更清晰更简单。使用插件，我们
      
    
    </summary>
    
    
      <category term=".NET" scheme="http://blog.iavjkaede.com/categories/NET/"/>
    
    
      <category term="C#" scheme="http://blog.iavjkaede.com/tags/C/"/>
    
      <category term="Plugins" scheme="http://blog.iavjkaede.com/tags/Plugins/"/>
    
  </entry>
  
  <entry>
    <title>.Net 中MimeType 的获取</title>
    <link href="http://blog.iavjkaede.com/2020/05/18/Get%20MimeType%20via%20.NET/"/>
    <id>http://blog.iavjkaede.com/2020/05/18/Get%20MimeType%20via%20.NET/</id>
    <published>2020-05-18T15:22:37.124Z</published>
    <updated>2020-06-21T13:19:43.246Z</updated>
    
    <content type="html"><![CDATA[<h3 id="NetFramework-中获取-MimeType"><a href="#NetFramework-中获取-MimeType" class="headerlink" title=".NetFramework 中获取 MimeType"></a>.NetFramework 中获取 MimeType</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// using System.Web;</span></span><br><span class="line">MimeMapping.GetMimeMapping(filename);</span><br></pre></td></tr></table></figure><h3 id="NetCore-中获取MimeType"><a href="#NetCore-中获取MimeType" class="headerlink" title=".NetCore 中获取MimeType"></a>.NetCore 中获取MimeType</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//using Microsoft.AspNetCore.StaticFiles;</span></span><br><span class="line">FileExtensionContentTypeProvider fileExtensionContentTypeProvider;</span><br><span class="line"><span class="keyword">string</span> contentType;</span><br><span class="line">fileExtensionContentTypeProvider.TryGetContentType(filename,<span class="keyword">out</span> contentType);</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;NetFramework-中获取-MimeType&quot;&gt;&lt;a href=&quot;#NetFramework-中获取-MimeType&quot; class=&quot;headerlink&quot; title=&quot;.NetFramework 中获取 MimeType&quot;&gt;&lt;/a&gt;.NetFramew
      
    
    </summary>
    
    
      <category term=".NET" scheme="http://blog.iavjkaede.com/categories/NET/"/>
    
    
      <category term="C#" scheme="http://blog.iavjkaede.com/tags/C/"/>
    
  </entry>
  
  <entry>
    <title>ASP.NET 之 IIS托管的后台任务</title>
    <link href="http://blog.iavjkaede.com/2019/06/01/ASP.NET%20Website%20Background%20Job/"/>
    <id>http://blog.iavjkaede.com/2019/06/01/ASP.NET%20Website%20Background%20Job/</id>
    <published>2019-06-01T04:39:00.000Z</published>
    <updated>2020-05-23T08:51:32.606Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ASP-NET-之-IIS托管的后台任务"><a href="#ASP-NET-之-IIS托管的后台任务" class="headerlink" title="ASP.NET 之 IIS托管的后台任务"></a>ASP.NET 之 IIS托管的后台任务</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>&emsp;&emsp;可能有这样一个需求，我们希望网站后台每隔一段时间自动执行某些任务。然而在网站部署到IIS上的情况下，由于IIS应用程序池自动回收的原因，导致任务中断，无法一直保持后台运行。</p><p>​        现在，我们来找出一个解决方法。嗯。</p><h2 id="环境简介"><a href="#环境简介" class="headerlink" title="环境简介"></a>环境简介</h2><p>这里是我在做这件事情时的一个部署和开发所使用的环境。</p><h3 id="系统环境"><a href="#系统环境" class="headerlink" title="系统环境"></a>系统环境</h3><p>Windows 10 1903</p><h3 id="开发环境"><a href="#开发环境" class="headerlink" title="开发环境"></a>开发环境</h3><p>工具：Visual Studio 2019</p><p>SDK：.Netframework 4.6.2 </p><h3 id="部署环境"><a href="#部署环境" class="headerlink" title="部署环境"></a>部署环境</h3><p>IIS Express</p><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><h3 id="利用定时器实现后台任务"><a href="#利用定时器实现后台任务" class="headerlink" title="利用定时器实现后台任务"></a>利用定时器实现后台任务</h3><p><strong>JobManager.cs</strong></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">JobManager</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Timer m_timer;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="title">JobManager</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">         m_timer = <span class="keyword">new</span> Timer(<span class="keyword">new</span> TimerCallback(TimerCallback));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">TimerCallback</span>(<span class="params"><span class="keyword">object</span> target</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// do work here</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// interval 1 min </span></span><br><span class="line">        m_timer.Change(TimeSpan.Zero, TimeSpan.FromMinutes(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用</p><p><code>JobManager.Start();</code></p><p>有关Timer的用法 可参考MSDN</p><p><a href="https://docs.microsoft.com/zh-cn/dotnet/api/system.threading.timer?f1url=https%3A%2F%2Fmsdn.microsoft.com%2Fquery%2Fdev15.query%3FappId%3DDev15IDEF1%26l%3DZH-CN%26k%3Dk(System.Threading.Timer);k(TargetFrameworkMoniker-.NETFramework,Version%3Dv4.6.2);k(DevLang-csharp)%26rd%3Dtrue&view=netframework-4.8" target="_blank" rel="noopener">Timer Class</a></p><p><strong>这样实现的任务有个致命缺陷，IIS 应用程序池自动回收的时候会毫不留情的将其摧毁。</strong></p><p>下面有两种异曲同工的解决方式。</p><hr><h3 id="Application-End-中唤醒-IIS"><a href="#Application-End-中唤醒-IIS" class="headerlink" title="Application_End 中唤醒 IIS"></a>Application_End 中唤醒 IIS</h3><p>​    应用程序池进行回收的时候会调用<em>Application_End</em> 方法，所以，在这里继续将IIS唤醒即可。</p><p>​    我把关键的代码放在这里</p><p><strong>Global.asax.cs</strong></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">async</span> <span class="keyword">void</span> <span class="title">Application_End</span>(<span class="params"><span class="keyword">object</span> sender,EventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 从这里唤醒你的网站，所以我们需要得到网站的地址</span></span><br><span class="line">    <span class="keyword">string</span> url = <span class="string">"http://www.yousite.com"</span>;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">          <span class="keyword">using</span>(HttpClient client = <span class="keyword">new</span> HttpClient())</span><br><span class="line">          &#123;</span><br><span class="line"> <span class="keyword">var</span> response = <span class="keyword">await</span> client.GetAsync(url);</span><br><span class="line">          &#125;</span><br><span class="line">    &#125;<span class="keyword">catch</span>(Exception)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 处理可能出现的异常</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可能还需要写个日志来记录情况或者用<em>HttpWebRequest</em>来发起请求，都没问题。</p><p>我们来看下一种方式。</p><hr><h3 id="IRegisteredObject-唤醒IIS"><a href="#IRegisteredObject-唤醒IIS" class="headerlink" title="IRegisteredObject 唤醒IIS"></a>IRegisteredObject 唤醒IIS</h3><h4 id="IRegisteredObject-接口"><a href="#IRegisteredObject-接口" class="headerlink" title="IRegisteredObject 接口"></a>IRegisteredObject 接口</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IRegisteredObject</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Stop</span>(<span class="params"><span class="keyword">bool</span> immediate</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>​    它是在<code>System.Web.Hosting</code> 下的一个接口，它是做什么用的呢？</p><p>搬运一下MSDN的描述 ：</p><hr><p><em>可以通过调用创建已注册对象的实例<a href="https://docs.microsoft.com/zh-cn/dotnet/api/system.web.hosting.applicationmanager.createobject?view=netframework-4.8" target="_blank" rel="noopener">ApplicationManager.CreateObject</a>的应用程序管理器中的方法。 应用程序管理器将新创建的对象返回给调用方，然后在对象调用特定于类型的方法。 在启动期间，已注册的对象应调用<a href="https://docs.microsoft.com/zh-cn/dotnet/api/system.web.hosting.hostingenvironment.registerobject?view=netframework-4.8" target="_blank" rel="noopener">HostingEnvironment.RegisterObject</a>方法以完成注册的对象。</em></p><p><em>当应用程序管理器需要停止已注册的对象时，它将调用<a href="https://docs.microsoft.com/zh-cn/dotnet/api/system.web.hosting.iregisteredobject.stop?view=netframework-4.8" target="_blank" rel="noopener">Stop</a>方法</em></p><p>是的，很抽象，反正这个描述我是看不懂。</p><p>简单说一下，就是<strong>应用程序池将要回收的时候，会调用Stop方法</strong>，那么我们可以在Stop中实现上面同样的逻辑。</p><hr><h4 id="IRegisteredObject-使用"><a href="#IRegisteredObject-使用" class="headerlink" title="IRegisteredObject 使用"></a>IRegisteredObject 使用</h4><p>首先要有一个类继承自 <code>IRegisteredObject</code></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">JobHost</span>:<span class="title">IRegisteredObject</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">JobHost</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">HostingEnvironment.RegisterObject(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Stop</span>(<span class="params"><span class="keyword">bool</span> immediate</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// 在这里唤醒IIS</span></span><br><span class="line">HostingEnvironment.UnregisterObject(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在使用JobHost 之前需要调用</p><p><code>HostingEnvironment.RegisterObject(this);</code> 进行注册</p><p>在Stop 被调用时  要调用</p><p><code>HostingEnvironment.UnregisterObject(this);</code> 进行反注册</p><hr><h3 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h3><p>通过第二种解决方式实现后台任务的完整代码</p><h5 id="JobHost-cs"><a href="#JobHost-cs" class="headerlink" title="JobHost.cs"></a>JobHost.cs</h5><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">JobHost</span> : <span class="title">IRegisteredObject</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> <span class="keyword">object</span> m_lock = <span class="keyword">new</span> <span class="keyword">object</span> ();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">bool</span> m_shuttingDown;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JobHost</span> (<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        HostingEnvironment.RegisterObject (<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Stop</span> (<span class="params"><span class="keyword">bool</span> immediate</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">lock</span> (m_lock)</span><br><span class="line">        &#123;</span><br><span class="line">            m_shuttingDown = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        HostingEnvironment.UnregisterObject (<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 程序池被回收的时候重新唤醒iis</span></span><br><span class="line">        JobManager.Wakeup ();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DoWork</span> (<span class="params">Action work</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">lock</span> (m_lock)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_shuttingDown)</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            work ();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="JobManager-cs"><a href="#JobManager-cs" class="headerlink" title="JobManager.cs"></a>JobManager.cs</h5><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">JobManager</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Timer m_timer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> JobHost m_jobHost = <span class="keyword">new</span> JobHost();</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="title">JobManager</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">         m_timer = <span class="keyword">new</span> Timer(<span class="keyword">new</span> TimerCallback(TimerCallback));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">TimerCallback</span>(<span class="params"><span class="keyword">object</span> target</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_jobHost.DoWork(()=&gt;&#123;</span><br><span class="line">            <span class="comment">// do work here</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// interval 1 min </span></span><br><span class="line">        m_timer.Change(TimeSpan.Zero, TimeSpan.FromMinutes(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">         <span class="keyword">string</span> url = <span class="string">"www.yousite.com"</span>;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">using</span>(HttpClient client = <span class="keyword">new</span> HttpClient())</span><br><span class="line">            &#123;</span><br><span class="line">               <span class="keyword">var</span> response = <span class="keyword">await</span> client.GetAsync(url);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 处理可能出现的异常</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我这里讲的不够详细，如果要参考更多细节，这里贴出参考的blog</p><p><a href="https://haacked.com/archive/2011/10/16/the-dangers-of-implementing-recurring-background-tasks-in-asp-net.aspx/" target="_blank" rel="noopener">The Dangers of Implementing Recurring Background Tasks In ASP.NET</a> </p><hr><h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>​    这种方式的原理很简单，IIS就像个贪睡的孩子，当他快要打瞌睡的时候，你就拍拍他的脑袋。</p><p>   “ 嘿，好孩子，该工作了。”</p><p>   没错，就是这么残酷😂。</p><p><strong>当我们需要持续稳定的执行后台任务的时候，更好的方式应该是写一个服务程序，或者控制台</strong></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.2cto.com/kf/201112/115331.html" target="_blank" rel="noopener">IIS 自动回收导致后台定时器失效的问题解决</a></p><p><a href="https://haacked.com/archive/2011/10/16/the-dangers-of-implementing-recurring-background-tasks-in-asp-net.aspx/" target="_blank" rel="noopener">The Dangers of Implementing Recurring Background Tasks In ASP.NET</a></p><p><a href="https://docs.microsoft.com/zh-cn/dotnet/api/system.threading.timer?f1url=https%3A%2F%2Fmsdn.microsoft.com%2Fquery%2Fdev15.query%3FappId%3DDev15IDEF1%26l%3DZH-CN%26k%3Dk(System.Threading.Timer);k(TargetFrameworkMoniker-.NETFramework,Version%3Dv4.6.2);k(DevLang-csharp)%26rd%3Dtrue&view=netframework-4.8" target="_blank" rel="noopener">Timer Class</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;ASP-NET-之-IIS托管的后台任务&quot;&gt;&lt;a href=&quot;#ASP-NET-之-IIS托管的后台任务&quot; class=&quot;headerlink&quot; title=&quot;ASP.NET 之 IIS托管的后台任务&quot;&gt;&lt;/a&gt;ASP.NET 之 IIS托管的后台任务&lt;/h1&gt;&lt;
      
    
    </summary>
    
    
      <category term=".NET" scheme="http://blog.iavjkaede.com/categories/NET/"/>
    
    
      <category term="IIS" scheme="http://blog.iavjkaede.com/tags/IIS/"/>
    
      <category term="Background Task" scheme="http://blog.iavjkaede.com/tags/Background-Task/"/>
    
      <category term="C#" scheme="http://blog.iavjkaede.com/tags/C/"/>
    
  </entry>
  
  <entry>
    <title>内网SVN穿透踩坑</title>
    <link href="http://blog.iavjkaede.com/2019/03/03/SVN%20nat/"/>
    <id>http://blog.iavjkaede.com/2019/03/03/SVN%20nat/</id>
    <published>2019-03-02T16:00:00.000Z</published>
    <updated>2020-05-23T08:52:41.637Z</updated>
    
    <content type="html"><![CDATA[<h1 id="记一次SVN-内网穿透代理"><a href="#记一次SVN-内网穿透代理" class="headerlink" title="记一次SVN 内网穿透代理"></a>记一次SVN 内网穿透代理</h1><h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>环境是这样的，内网有一台SVN服务器 S，一台能访问外网的主机A。首先，我没有SVN服务器的管理权限，只能通过主机A去访问 服务器S。现在我需要通过外网去访问内网的SVN服务。</p><p>我的思路是，用主机A 反代 服务器S ，然后使用内网穿透服务将主机A暴露在外网中。</p><p>所以需要做以下准备</p><ol><li>按照反向代理服务</li><li>选择内网穿透服务</li></ol><p>这里我用nginx 做反向代理，用Natapp 做内网穿透，Natapp 是收费（免费的通道域名会隔段时间变动，不嫌弃麻烦可以用）的且需要实名认证，如果觉得不适用可以有自己服务器的话可以自行搭建内网穿透服务，这里不多说。</p><p>说一下我的A主机具体环境</p><p>Win 10 1903</p><p>WSL Debian 9</p><p>我选择用WSL 来做这一切，在这里面跑服务再好不过了。</p><h2 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h2><p>现在开始详细的说一下，这里面有坑，需要留意</p><h3 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h3><p>首先安装nginx </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install nginx</span><br></pre></td></tr></table></figure><p>启用 nginx</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service nginx start</span><br></pre></td></tr></table></figure><p>配置反代</p><p>我们在<code>/etc/nginx/conf.d</code> 中建立一个配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim svnproxy.conf</span><br></pre></td></tr></table></figure><p>输入以下内容，我做详细解释</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">listen</span> <span class="number">7777</span>;<span class="comment"># nginx 监听的端口号，反代的服务通过此端口向外服务</span></span><br><span class="line">        <span class="attribute">server_name</span> localhost;</span><br><span class="line">        <span class="attribute">location</span> /&#123;</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">                <span class="attribute">set</span> <span class="variable">$fixed_destination</span> <span class="variable">$http_destination</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 这个地方很重要，坑在这，如果我们通过 http 协议来访问我们</span></span><br><span class="line">        <span class="comment"># 的主机A，而主机A 需要通过https协议访问SVN服务器</span></span><br><span class="line">        <span class="comment"># 那么需要向下面三行这样写</span></span><br><span class="line">                <span class="attribute">if</span> ( <span class="variable">$http_destination</span> <span class="regexp">~* ^http(.*)$</span> ) &#123;</span><br><span class="line">                <span class="attribute">set</span> <span class="variable">$fixed_destination</span> https<span class="variable">$1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 反之，如果你通过https协议访问主机A，通过http协议访问 SVN服务器</span></span><br><span class="line">        <span class="comment"># 需要像这么写，区别很明显，我不再多说</span></span><br><span class="line">            <span class="comment">#if ( $http_destination ~* ^https(.*)$ ) &#123;</span></span><br><span class="line">                <span class="comment">#set $fixed_destination http$1;</span></span><br><span class="line">                <span class="comment">#&#125;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 不像上面做会出什么问题呢，问题就是，外网通过主机A可以正常进行Update，但是无法Commit，原因大致是http COPY PUT 之类的操作经过反代无法正确执行。</span></span><br><span class="line">        </span><br><span class="line">                <span class="attribute">proxy_set_header</span> Destination <span class="variable">$fixed_destination</span>;</span><br><span class="line">                <span class="attribute">proxy_set_header</span> Host <span class="variable">$http_host</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 要反代的SVN服务器地址，确保SVN服务能提供Https 访问</span></span><br><span class="line">                <span class="attribute">proxy_pass</span>      https://192.168.0.2;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>配置好保存我们重载下nginx</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -t &amp;&amp; nginx -s reload</span><br></pre></td></tr></table></figure><p>可以在本地通过浏览器 访问A 主机的<code>7777</code> 端口看一下，用SVN在本地测试以下也Ok</p><h3 id="穿透"><a href="#穿透" class="headerlink" title="穿透"></a>穿透</h3><p>穿透的过程我就不在详细讲了。在Natapp 上开条隧道，web服务用的，然后下载它的程序在WLS启动，网站上都用怎么用哈，代理端口号填写上面配置的端口号就可以了。避免麻烦的话可以买个收费的隧道，价格可以，主要有固定域名。要说一点的是，可以用Supervisor 做个进程守护，然后配置下开机自启（我有写过这个的），完美。</p><h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p>有个坑我一定要讲一下，我在主机A上使用SVN服务一切正常，然后反代后通过外网访问SVN，发现重命名的文件没办法提交了。经过一番折磨终于找到了问题，那就是<strong>SVN 仓库文件夹中有中文字符</strong>，很坑，所以SVN仓库里最好不要出现中文路径。</p><p>到此，告一段落。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;记一次SVN-内网穿透代理&quot;&gt;&lt;a href=&quot;#记一次SVN-内网穿透代理&quot; class=&quot;headerlink&quot; title=&quot;记一次SVN 内网穿透代理&quot;&gt;&lt;/a&gt;记一次SVN 内网穿透代理&lt;/h1&gt;&lt;h2 id=&quot;准备&quot;&gt;&lt;a href=&quot;#准备&quot; cla
      
    
    </summary>
    
    
      <category term="Deploy" scheme="http://blog.iavjkaede.com/categories/Deploy/"/>
    
    
      <category term="Deploy" scheme="http://blog.iavjkaede.com/tags/Deploy/"/>
    
      <category term="NAT" scheme="http://blog.iavjkaede.com/tags/NAT/"/>
    
  </entry>
  
  <entry>
    <title>Linux子系统(WSL)中的服务开机启动</title>
    <link href="http://blog.iavjkaede.com/2019/03/02/WSL%20Service%20Autostart/"/>
    <id>http://blog.iavjkaede.com/2019/03/02/WSL%20Service%20Autostart/</id>
    <published>2019-03-02T04:24:00.000Z</published>
    <updated>2020-05-23T08:52:49.205Z</updated>
    
    <content type="html"><![CDATA[<h2 id="环境简介"><a href="#环境简介" class="headerlink" title="环境简介"></a>环境简介</h2><h3 id="系统环境"><a href="#系统环境" class="headerlink" title="系统环境"></a>系统环境</h3><p>开了WSL 的<strong>Windows LTSC 2019</strong> </p><p>WSL ： <strong>Debian 发行版</strong></p><h3 id="Shell-环境"><a href="#Shell-环境" class="headerlink" title="Shell 环境"></a>Shell 环境</h3><p>WSL Shell  使用 <strong>ZSH</strong></p><h2 id="简短截说"><a href="#简短截说" class="headerlink" title="简短截说"></a>简短截说</h2><p>这个解决方式是在知乎上看到的，这里仅仅是搬运一下，做个记录。</p><p><a href="https://zhuanlan.zhihu.com/p/47733615" target="_blank" rel="noopener">WSL 服务自动启动的正确方法</a></p><h3 id="创建并编辑init-wsl"><a href="#创建并编辑init-wsl" class="headerlink" title="创建并编辑init.wsl"></a>创建并编辑init.wsl</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/init.wsl</span><br></pre></td></tr></table></figure><p><strong>init.wsl</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#! /bin/sh</span></span><br><span class="line"></span><br><span class="line">/etc/init.d/ssh <span class="variable">$1</span></span><br><span class="line">/etc/init.d/supervisor <span class="variable">$1</span></span><br></pre></td></tr></table></figure><h3 id="设置权限"><a href="#设置权限" class="headerlink" title="设置权限"></a>设置权限</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo chown root:root /etc/init.wsl</span><br><span class="line">sudo chmod +x /etc/init.wsl</span><br></pre></td></tr></table></figure><h3 id="创建VBS脚本"><a href="#创建VBS脚本" class="headerlink" title="创建VBS脚本"></a>创建VBS脚本</h3><p>在Windows 中 <code>Win+R</code> 运行 <code>shell :startup</code></p><p>在弹出的目录中创建<code>debian.vbs</code>，如果你用的别的发行版，比如ubuntu18.04，文件名就是<code>ubuntu1804.vbs</code></p><p>如果不知道自己的发行版名称可以通过以下命令查看</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wsl <span class="literal">-l</span></span><br></pre></td></tr></table></figure><p><em>这条命令是在Ｗidows终端中执行而非在WSL中，在我的系统（LTSC 2019)中这条命令并非有效</em></p><p>或者可以尝试这个命令</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wslconfig /l</span><br></pre></td></tr></table></figure><h3 id="编辑VBS脚本"><a href="#编辑VBS脚本" class="headerlink" title="编辑VBS脚本"></a>编辑VBS脚本</h3><p><strong>debian.vbs</strong></p><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Set</span> ws = <span class="built_in">CreateObject</span>(<span class="string">"Wscript.Shell"</span>)</span><br><span class="line">ws.run <span class="string">"wsl -d debian -u root /etc/init.wsl start"</span>, vbhide</span><br></pre></td></tr></table></figure><p>保存文件后，所有的步骤就都进行完了。</p><h2 id="原文链接"><a href="#原文链接" class="headerlink" title="原文链接"></a>原文链接</h2><p><a href="https://zhuanlan.zhihu.com/p/47733615" target="_blank" rel="noopener">WSL 服务自动启动的正确方法</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;环境简介&quot;&gt;&lt;a href=&quot;#环境简介&quot; class=&quot;headerlink&quot; title=&quot;环境简介&quot;&gt;&lt;/a&gt;环境简介&lt;/h2&gt;&lt;h3 id=&quot;系统环境&quot;&gt;&lt;a href=&quot;#系统环境&quot; class=&quot;headerlink&quot; title=&quot;系统环境&quot;&gt;&lt;/a
      
    
    </summary>
    
    
      <category term="Deploy" scheme="http://blog.iavjkaede.com/categories/Deploy/"/>
    
    
      <category term="WSL" scheme="http://blog.iavjkaede.com/tags/WSL/"/>
    
      <category term="Debian" scheme="http://blog.iavjkaede.com/tags/Debian/"/>
    
  </entry>
  
</feed>
